function calculateResultsLocally(){quizState.correctAnswers=0,quizState.incorrectAnswers=0,quizState.totalMarks=0;for(let e=0;e<quizConfig.totalQuestions;e++){let t=quizState.answers[e];null!==t&&(t===quizConfig.answers[e]-1?(quizState.correctAnswers++,quizState.totalMarks+=quizConfig.correctMark):(quizState.incorrectAnswers++,quizState.totalMarks+=quizConfig.incorrectPenalty))}quizState.skippedQuestions=quizConfig.totalQuestions-quizState.correctAnswers-quizState.incorrectAnswers,quizState.score=Math.max(0,Math.round(quizState.totalMarks/quizConfig.maxMarks*100)),calculateSubjectWisePerformance()}function calculateSubjectWisePerformance(){quizState.subjectWise={physics:{correct:0,total:45,percentage:0},chemistry:{correct:0,total:45,percentage:0},biology:{correct:0,total:90,percentage:0}};for(let e=0;e<quizConfig.totalQuestions;e++){let t=quizState.answers[e],n=e+1,s;s=n<=45?"physics":n<=90?"chemistry":"biology",null!==t&&t===quizConfig.answers[e]-1&&quizState.subjectWise[s].correct++}Object.keys(quizState.subjectWise).forEach(e=>{quizState.subjectWise[e].percentage=quizState.subjectWise[e].total>0?Math.round(quizState.subjectWise[e].correct/quizState.subjectWise[e].total*100):0})}async function initQuiz(){try{userId=generateUserId(),[quizConfig,quizState.questionPages,quizState.pdfUrl]=await Promise.all([fetchQuizConfig(),fetchQuestionPages(),fetchPdfUrl()]),quizState.totalPages=quizConfig.totalPages||100,quizState.questionTimes=Array(quizConfig.totalQuestions).fill(0),quizState.answers=Array(quizConfig.totalQuestions).fill(null),elements.totalQuestions.textContent=quizConfig.totalQuestions,elements.jumpToQuestion.max=quizConfig.totalQuestions,elements.totalPages.textContent=quizState.totalPages,setTimeout(()=>{elements.loadingScreen.style.display="none",elements.quizContainer.style.display="block",startQuiz()},800)}catch(e){console.error("Failed to initialize quiz:",e),elements.loadingScreen.innerHTML=`
            <h2>Error Loading Quiz</h2>
            <p>Please check your internet connection and try again.</p>
            <button onclick="location.reload()" class="aa0105-btn aa0105-btn-primary">
                <i class="fas fa-redo"></i> Retry
            </button>
        `}}function startQuiz(){quizState.startTime=new Date,questionStartTime=new Date,startTimer(),loadQuestion(quizState.currentQuestionIndex),updateProgressBar()}function loadQuestion(e){if(e<0||e>=quizConfig.totalQuestions)return;if(questionStartTime&&quizState.currentQuestionIndex!==e){let t=new Date,n=Math.floor((t-questionStartTime)/1e3);quizState.questionTimes[quizState.currentQuestionIndex]=n,quizState.timeSpent+=n}quizState.currentQuestionIndex=e,questionStartTime=new Date,elements.questionNumber.textContent=e+1,elements.currentQuestion.textContent=e+1,elements.jumpToQuestion.value=e+1;let s=quizState.questionPages[e+1]||1;quizState.currentPage=s,elements.currentPageInput.value=s;let a=`${quizState.pdfUrl}#page=${s}`;elements.pdfFrame.src=a,elements.optionsContainer.innerHTML="";for(let o=0;o<4;o++){let i=document.createElement("button");i.className="aa0105-option",i.textContent=`Option ${String.fromCharCode(65+o)}`,i.dataset.index=o,null!==quizState.answers[e]&&(quizState.answers[e]===o&&i.classList.add("aa0105-selected"),o===quizConfig.answers[e]-1?i.classList.add("aa0105-correct"):quizState.answers[e]===o&&quizState.answers[e]!==quizConfig.answers[e]-1&&i.classList.add("aa0105-wrong"),i.disabled=!0),i.addEventListener("click",()=>selectOption(o)),elements.optionsContainer.appendChild(i)}elements.prevBtn.disabled=0===e,elements.nextBtn.disabled=e===quizConfig.totalQuestions-1,elements.submitBtn.style.display=e===quizConfig.totalQuestions-1?"inline-block":"none",elements.submitQuestionBtn.style.display=(quizState.answers[e],"none"),elements.explanationBtn.style.display=null!==quizState.answers[e]?"inline-block":"none",updateProgressBar()}function selectOption(e){document.querySelectorAll(".aa0105-option").forEach(e=>{e.classList.remove("aa0105-selected")});let t=document.querySelector(`.aa0105-option[data-index="${e}"]`);t.classList.add("aa0105-selected"),elements.submitQuestionBtn.style.display="inline-block"}function submitAnswer(){let e=document.querySelector(".aa0105-option.aa0105-selected");if(!e){alert("Please select an answer first.");return}let t=parseInt(e.dataset.index),n=quizState.currentQuestionIndex,s=quizConfig.answers[n]-1;if(quizState.answers[n]=t,document.querySelectorAll(".aa0105-option").forEach(e=>e.disabled=!0),document.querySelectorAll(".aa0105-option").forEach((e,n)=>{n===s?e.classList.add("aa0105-correct"):n===t&&n!==s&&e.classList.add("aa0105-wrong")}),t===s){quizState.correctAnswers++,quizState.totalMarks+=quizConfig.correctMark;let a=n+1;a<=45?quizState.subjectWise.physics.correct++:a<=90?quizState.subjectWise.chemistry.correct++:quizState.subjectWise.biology.correct++}else quizState.incorrectAnswers++,quizState.totalMarks+=quizConfig.incorrectPenalty;quizState.score=Math.max(0,Math.round(quizState.totalMarks/quizConfig.maxMarks*100)),elements.currentScore.textContent=quizState.score,elements.submitQuestionBtn.style.display="none",elements.explanationBtn.style.display="inline-block",n<quizConfig.totalQuestions-1&&setTimeout(()=>{loadQuestion(n+1)},1200)}function showExplanation(){let e=quizState.currentQuestionIndex,t=quizState.questionPages[`exp_${e+1}`]||1,n=`${quizState.pdfUrl}#page=${t}`;elements.explanationPdfFrame.src=n,elements.explanationText.textContent=`This is the explanation for question ${e+1}. The correct answer is Option ${String.fromCharCode(64+quizConfig.answers[e])}.`,elements.explanationModal.style.display="block",elements.explanationModal.style.opacity="0",setTimeout(()=>{elements.explanationModal.style.transition="opacity 0.3s ease",elements.explanationModal.style.opacity="1"},50)}function startTimer(){quizTimer=setInterval(()=>{let e=new Date,t=Math.floor((e-quizState.startTime)/1e3),n=`${Math.floor(t/3600).toString().padStart(2,"0")}:${Math.floor(t%3600/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`;elements.clock.textContent=n,elements.floatingClock.textContent=n,quizConfig.timeLimit&&t>=quizConfig.timeLimit&&(clearInterval(quizTimer),submitQuiz())},1e3)}async function submitQuiz(){if(clearInterval(quizTimer),quizState.endTime=new Date,quizState.completed=!0,questionStartTime){let e=new Date,t=Math.floor((e-questionStartTime)/1e3);quizState.questionTimes[quizState.currentQuestionIndex]=t,quizState.timeSpent+=t}let n=await submitQuizResults();calculateSubjectWisePerformance(),showResults(n),quizState.score>=quizConfig.passingScore&&createConfetti()}function showResults(e){elements.quizContainer.style.display="none",elements.resultsContainer.style.display="block",e?(elements.correctAnswers.textContent=e.correctAnswers,elements.incorrectAnswers.textContent=e.incorrectAnswers,elements.skippedAnswers.textContent=quizConfig.totalQuestions-e.correctAnswers-e.incorrectAnswers,elements.totalMarksDisplay.textContent=e.totalMarks):(elements.correctAnswers.textContent=quizState.correctAnswers,elements.incorrectAnswers.textContent=quizState.incorrectAnswers,elements.skippedAnswers.textContent=quizState.skippedQuestions,elements.totalMarksDisplay.textContent=quizState.totalMarks);let t=Math.floor(quizState.timeSpent/3600),n=Math.floor(quizState.timeSpent%3600/60),s=quizState.timeSpent%60,a=`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;elements.timeTaken.textContent=a,elements.correctCount.textContent=e?e.correctAnswers:quizState.correctAnswers,elements.totalCount.textContent=quizConfig.totalQuestions,elements.totalTimeSpent.textContent=Math.round(n+s/60),elements.resultsProgressBar.style.width=`${quizState.score}%`,generateQuestionReview(),generateTimeAnalysis()}function generateQuestionReview(){elements.questionReview.innerHTML="";for(let e=0;e<quizConfig.totalQuestions;e++){let t=quizState.answers[e],n=null!==t&&t===quizConfig.answers[e]-1,s=null===t,a=document.createElement("div");a.className="aa0105-review-item",s?a.classList.add("aa0105-skipped"):n?a.classList.add("aa0105-correct"):a.classList.add("aa0105-incorrect");let o=document.createElement("div");o.className="aa0105-review-question";let i="#FF6B6B";i=e+1<=45?"#FF6B6B":e+1<=90?"#4ECDC4":"#45B7D1";let r=document.createElement("div");r.innerHTML=`
            <strong style="color: ${i}">Q${e+1}</strong>: 
            Page ${quizState.questionPages[e+1]||1}
        `;let l=document.createElement("div");l.className=`aa0105-review-status ${s?"aa0105-skipped-status":n?"aa0105-correct-status":"aa0105-incorrect-status"}`,l.textContent=s?"Skipped":n?`Correct (+${quizConfig.correctMark})`:`Incorrect (${quizConfig.incorrectPenalty})`,o.appendChild(r),o.appendChild(l);let c=document.createElement("div");c.className="aa0105-review-options";for(let $=0;$<4;$++){let u=document.createElement("div");u.className="aa0105-review-option",$===t&&u.classList.add("aa0105-selected-option"),$===quizConfig.answers[e]-1&&u.classList.add("aa0105-correct-option"),u.textContent=`Option ${String.fromCharCode(65+$)}`,c.appendChild(u)}let d=document.createElement("div");d.className="aa0105-time-info",d.innerHTML=`<strong>Time spent:</strong> ${quizState.questionTimes[e]} seconds`;let p=document.createElement("div");p.className="aa0105-marks-info",p.innerHTML=`<strong>Marks:</strong> ${s?"0":n?`+${quizConfig.correctMark}`:quizConfig.incorrectPenalty}`;let m=document.createElement("button");m.className="aa0105-btn aa0105-btn-explanation",m.innerHTML='<i class="fas fa-lightbulb"></i> Show Explanation',m.onclick=()=>{showExplanationForReview(e)},a.appendChild(o),a.appendChild(c),a.appendChild(d),a.appendChild(p),a.appendChild(m),elements.questionReview.appendChild(a)}}function showExplanationForReview(e){let t=quizState.questionPages[`exp_${e+1}`]||1,n=`${quizState.pdfUrl}#page=${t}`;elements.explanationPdfFrame.src=n,elements.explanationText.textContent=`This is the explanation for question ${e+1}. The correct answer is Option ${String.fromCharCode(64+quizConfig.answers[e])}.`,elements.explanationModal.style.display="block",elements.explanationModal.style.opacity="0",setTimeout(()=>{elements.explanationModal.style.transition="opacity 0.3s ease",elements.explanationModal.style.opacity="1"},50)}function generateTimeAnalysis(){let e=quizState.questionTimes.filter(e=>e>0),t=e.length>0?(e.reduce((e,t)=>e+t,0)/e.length).toFixed(1):0,n=-1,s=-1,a=e.length>0?e[0]:0,o=e.length>0?e[0]:0;for(let i=0;i<quizState.questionTimes.length;i++)quizState.questionTimes[i]>0&&((-1===n||quizState.questionTimes[i]<a)&&(a=quizState.questionTimes[i],n=i),(-1===s||quizState.questionTimes[i]>o)&&(o=quizState.questionTimes[i],s=i));elements.avgTimePerQuestion.textContent=t,elements.fastestQuestion.textContent=-1!==n?n+1:"N/A",elements.fastestTime.textContent=-1!==n?a:"N/A",elements.slowestQuestion.textContent=-1!==s?s+1:"N/A",elements.slowestTime.textContent=-1!==s?o:"N/A",elements.timeSpentChart.innerHTML="";let r=Math.max(...quizState.questionTimes,1);quizState.questionTimes.forEach((e,t)=>{let a=document.createElement("div");a.style.height=e>0?`${e/r*100}%`:"5px",a.style.width="20px";let o;o=t<45?"#FF6B6B":t<90?"#4ECDC4":"#45B7D1",e>0&&t===n?a.style.backgroundColor="#4CAF50":e>0&&t===s?a.style.backgroundColor="#F44336":a.style.backgroundColor=e>0?o:"#cccccc",a.style.display="inline-block",a.style.margin="0 2px",a.style.position="relative",a.title=`Q${t+1}: ${e}s`;let i=document.createElement("div");i.textContent=t+1,i.style.position="absolute",i.style.bottom="-20px",i.style.left="0",i.style.fontSize="10px",i.style.textAlign="center",i.style.width="20px",a.appendChild(i),elements.timeSpentChart.appendChild(a)})}function updateProgressBar(){let e=(quizState.currentQuestionIndex+1)/quizConfig.totalQuestions*100;elements.progressBar.style.width=`${e}%`}function createConfetti(){for(let e=0;e<100;e++){let t=document.createElement("div");t.className="aa0105-confetti",t.style.left=`${100*Math.random()}vw`,t.style.backgroundColor=`hsl(${360*Math.random()}, 100%, 50%)`,t.style.width=`${10*Math.random()+5}px`,t.style.height=`${10*Math.random()+5}px`,t.style.animationDuration=`${3*Math.random()+2}s`,document.body.appendChild(t),setTimeout(()=>{t.remove()},5e3)}}function navigateToPage(e){if(e>=1&&e<=quizState.totalPages){quizState.currentPage=e,elements.currentPageInput.value=e;let t=`${quizState.pdfUrl}#page=${e}`;elements.pdfFrame.src=t}}